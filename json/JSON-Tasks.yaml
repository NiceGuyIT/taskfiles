---
version: '3'

tasks:

  file-append:
    desc: Append (or merge) one JSON file onto another JSON file.
    summary: |
      This task will verify both JSON files are valid JSON files, and then append the 2nd file onto the first file.

      variables:
       - ORIGINAL_FILE: Original JSON file.
       - APPENDED_FILE: JSON file to append to the original.
       - ORIGINAL_TRANSFORMATION: JSON transformation to apply to the original file.
       - APPENDED_TRANSFORMATION: JSON transformation to apply to the appended file.
       - SU_USER: If set, the commands will be wrapped in 'su'.
    vars:
      ORIGINAL_FILE: '{{.ORIGINAL_FILE}}'
      APPENDED_FILE: '{{.APPENDED_FILE}}'
      ORIGINAL_TRANSFORMATION: '{{.ORIGINAL_TRANSFORMATION}}'
      APPENDED_TRANSFORMATION: '{{.APPENDED_TRANSFORMATION}}'
      SU_USER: '{{.SU_USER}}'
    preconditions:
      - task: :install:yq
      - sh: '[ {{ quote ORIGINAL_FILE }} != "" ]'
        msg: 'ORIGINAL_FILE {{ quote ORIGINAL_FILE }} is not defined. Please set it to the original file.'
      - sh: '[ {{ quote APPENDED_FILE }} != "" ]'
        msg: 'APPENDED_FILE {{ quote APPENDED_FILE }} is not defined. Please set it to the file to append.'
      - sh: '[ -f {{ squote .ORIGINAL_FILE }} ]'
        msg: 'ORIGINAL_FILE {{ quote ORIGINAL_FILE }} does not exist or is not a file. Please set it to the original file.'
      - sh: '[ -f {{ squote .APPENDED_FILE }} ]'
        msg: 'APPENDED_FILE {{ quote APPENDED_FILE }} does not exist or is not a file. Please set it to the file to append.'
    cmds:
      - cmd: 'echo "ORIGINAL_FILE: {{.ORIGINAL_FILE}}"'
      - cmd: 'echo "APPENDED_FILE: {{.APPENDED_FILE}}"'
      - cmd: 'echo "ORIGINAL_TRANSFORMATION: {{.ORIGINAL_TRANSFORMATION}}"'
      - cmd: 'echo "APPENDED_TRANSFORMATION: {{.APPENDED_TRANSFORMATION}}"'
      - cmd: 'echo "SU_USER: {{.SU_USER}}"'
      # Validate both JSON files before merging.
      - cmd: |
          {{ if and .SU_USER (ne .USER .SU_USER) }}su {{.SU_USER}} << 'EOT'{{ end }}
            yq --output-format=json 'true' {{ squote .ORIGINAL_FILE }}
          {{ if and .SU_USER (ne .USER .SU_USER) }}EOT{{ end }}
      - cmd: |
          {{ if and .SU_USER (ne .USER .SU_USER) }}su {{.SU_USER}} << 'EOT'{{ end }}
            yq --output-format=json 'true' {{ squote .APPENDED_FILE }}
          {{ if and .SU_USER (ne .USER .SU_USER) }}EOT{{ end }}
      # '(select(fileIndex == 0)) + (select(fileIndex == 1) | .[].name |= ({{ quote SCRIPT_PREFIX }} + .))' \
      - cmd: |
          {{ if and .SU_USER (ne .USER .SU_USER) }}su {{.SU_USER}} << 'EOT'{{ end }}
            yq eval-all --inplace --output-format=json \
              '(select(fileIndex == 0) {{- if .ORIGINAL_TRANSFORMATION }} | {{ .ORIGINAL_TRANSFORMATION }} {{ end -}} )
                + (select(fileIndex == 1) {{- if .APPENDED_TRANSFORMATION }} | {{ .APPENDED_TRANSFORMATION }} {{ end -}} )' \
              {{ squote .ORIGINAL_FILE }} \
              {{ squote .APPENDED_FILE }}
          {{ if and .SU_USER (ne .USER .SU_USER) }}EOT{{ end }}
